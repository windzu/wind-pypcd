name: Publish Release

on:
    release:
        types: [published]

jobs:
    publish-to-pypi:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Check out repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install build tooling
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install build twine

            - name: Verify tag matches project version
              env:
                  GITHUB_REF: ${{ github.ref }}
              run: |
                  python - <<'PYTHON'
                  import os
                  import pathlib
                  import sys
                  import tomllib

                  ref = os.environ.get("GITHUB_REF", "")
                  tag = ref.split("/")[-1]
                  if tag.startswith("refs"):
                      tag = ref.split("/")[-1]
                  if not tag:
                      print("Unable to determine tag from GITHUB_REF.")
                      sys.exit(1)

                  normalized = tag[1:] if tag.startswith("v") else tag
                  data = tomllib.loads(pathlib.Path("pyproject.toml").read_text())
                  version = data.get("project", {}).get("version")
                  if version is None:
                      print("project.version not found in pyproject.toml")
                      sys.exit(1)
                  if version != normalized:
                      print(f"Version mismatch: tag {tag} vs pyproject.toml {version}")
                      sys.exit(1)
                  PYTHON

            - name: Build sdist and wheel
              run: python -m build

            - name: Check built artifacts
              run: twine check dist/*

            - name: Publish to PyPI
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
              run: twine upload --non-interactive dist/*
